<!DOCTYPE html>
<html>
<head>
  <title>Eligible Schemes</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>Eligible Schemes</h2>
<ul id="schemesList"></ul>

<script>
const SUPABASE_URL = "https://glhrtvlhqgamjaqwwehe.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsaHJ0dmxocWdhbWphcXd3ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxOTQ4NjYsImV4cCI6MjA4NTc3MDg2Nn0.2w9PaGy7kTKmJ9oBUxZ_E8awGViyYvDZEt1FxrpCQ4Y";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadSchemes() {
  const { data: userData } = await db.auth.getUser();

  if (!userData.user) {
    window.location.href = "index.html";
    return;
  }

  const userId = userData.user.id;

  const { data: profile, error: profileError } = await db
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  console.log("PROFILE:", profile);

  const { data: schemes, error: schemesError } = await db
    .from("schemes")
    .select("*");

  console.log("ALL SCHEMES:", schemes);

  if (!profile || !schemes) {
    alert("Profile or schemes not found");
    return;
  }

  const eligible = schemes.filter(s => {
  const age = Number(profile.age);
  const income = Number(profile.income);

  const minAge = Number(s.min_age);
  const maxAge = Number(s.max_age);
  const minIncome = Number(s.min_income);
  const maxIncome = Number(s.max_income);

  const genderMatch =
    s.gender.toLowerCase().trim() === "any" ||
    s.gender.toLowerCase().trim() === profile.gender.toLowerCase().trim();

  const casteMatch =
    s.caste.toLowerCase().trim() === "any" ||
    s.caste.toLowerCase().trim() === profile.caste.toLowerCase().trim();

  const stateMatch =
    s.state.toLowerCase().trim() === "any" ||
    s.state.toLowerCase().trim() === profile.state.toLowerCase().trim();

  const match =
    age >= minAge &&
    age <= maxAge &&
    income >= minIncome &&
    income <= maxIncome &&
    genderMatch &&
    casteMatch &&
    stateMatch;

  console.log("CHECK:", s.scheme_name, {
    age, minAge, maxAge,
    income, minIncome, maxIncome,
    genderMatch, casteMatch, stateMatch,
    match
  });

  return match;
});


  console.log("ELIGIBLE:", eligible);

  const list = document.getElementById("schemesList");
  list.innerHTML = "";

  if (eligible.length === 0) {
    list.innerHTML = "<li>‚ùå No eligible schemes found</li>";
    return;
  }

  eligible.forEach(s => {
    const li = document.createElement("li");
    li.innerHTML = `<b>${s.scheme_name}</b> - ${s.description}`;
    list.appendChild(li);
  });
}


loadSchemes();
</script>

</body>
</html>

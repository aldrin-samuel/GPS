<!DOCTYPE html>
<html>
<head>
  <title>Eligible Schemes</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="schemes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="page-wrapper">
  <div class="navbar">
    <h3>Scheme Finder</h3>
    <button class="logout-btn" onclick="logout()">Logout</button>

  </div>

  <h2>Eligible Schemes</h2>
  <div id="schemesList" class="schemes-container"></div>
</div>

<script>
const SUPABASE_URL = "https://glhrtvlhqgamjaqwwehe.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsaHJ0dmxocWdhbWphcXd3ZWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxOTQ4NjYsImV4cCI6MjA4NTc3MDg2Nn0.2w9PaGy7kTKmJ9oBUxZ_E8awGViyYvDZEt1FxrpCQ4Y";


const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadSchemes() {
  const { data: { user } } = await db.auth.getUser();

  // ✅ If not logged in → back to login
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const userId = user.id;

  const { data: profile } = await db
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();

  // ✅ If profile not exists → go to profile page
  if (!profile) {
    window.location.href = "profile.html";
    return;
  }

  const { data: schemes } = await db.from("schemes").select("*");

  const eligible = schemes.filter(s => {
    return (
      profile.age >= s.min_age &&
      profile.age <= s.max_age &&
      profile.income >= s.min_income &&
      profile.income <= s.max_income &&
      (s.gender === "any" || s.gender.toLowerCase() === profile.gender.toLowerCase()) &&
      (s.caste === "any" || s.caste.toLowerCase() === profile.caste.toLowerCase()) &&
      (s.state === "any" || s.state.toLowerCase() === profile.state.toLowerCase())
    );
  });

  const container = document.getElementById("schemesList");
  container.innerHTML = "";

  if (eligible.length === 0) {
    container.innerHTML = `<div class="empty-msg">❌ No eligible schemes found</div>`;
    return;
  }

  eligible.forEach(s => {
    const card = document.createElement("div");
    card.className = "scheme-card";

    card.innerHTML = `
      <div class="scheme-title">${s.scheme_name}</div>
      <div class="scheme-desc">${s.description}</div>

      <div class="scheme-meta">
        <div>Age: ${s.min_age} - ${s.max_age}</div>
        <div>Income: ${s.min_income} - ${s.max_income}</div>
        <div>Gender: ${s.gender}</div>
        <div>Caste: ${s.caste}</div>
        <div>State: ${s.state}</div>
      </div>
    `;

    container.appendChild(card);
  });
}

async function logout() {
  await db.auth.signOut();
  window.location.href = "index.html";
}

loadSchemes();
</script>

</body>
</html>
